<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inventario — Admin</title>
    <link rel="stylesheet" href="/styles/main.css" />
</head>

<body class="has-sidebar">
    <div data-include="../../components/sidebar.html"></div>
    <h1>Inventario de productos</h1>
    <p class="muted">Lista de productos con su ID, nombre, precio y cantidad disponible. Si no hay stock se mostrará
        <strong>Sin existencia</strong>.
    </p>

    <div id="inventory-container" class="has-sidebar">
        <div style="margin:12px 0">
            <button id="open-add-product" class="btn">Agregar producto</button>
        </div>
        <div class="table-wrap">
            <table id="inventory-table" aria-describedby="inventory-desc">
                <caption id="inventory-desc" style="caption-side:top;text-align:left;padding-bottom:8px"></caption>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Cantidad</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="inventory-empty" class="empty" style="display:none">No se encontraron productos.</div>
    </div>

    <!-- Modal: Add Product (fixed overlay, click outside does NOT close) -->
    <div id="add-product-modal" class="modal" role="dialog" aria-hidden="true" style="display:none;position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:10000;padding:20px;">
        <div class="modal-content" role="document"
            style="max-width:720px;width:100%;padding:20px;background:#fff;border-radius:6px;box-shadow:0 6px 24px rgba(0,0,0,.2);overflow:auto;max-height:calc(100vh - 80px);">
            <button id="close-add-product" class="modal-close" aria-label="Cerrar" style="float:right">✕</button>
            <h2>Agregar producto</h2>
            <form id="add-product-form">
                <div class="form-row">
                    <label for="p-nombre">Nombre</label>
                    <input id="p-nombre" name="nombre" type="text" required />
                </div>
                <div class="form-row">
                    <label for="p-descripcion">Descripción</label>
                    <textarea id="p-descripcion" name="descripcion" rows="3" required></textarea>
                </div>
                <div class="form-row" style="display:flex;gap:8px">
                    <div style="flex:1">
                        <label for="p-precio">Precio</label>
                        <input id="p-precio" name="precio" type="number" step="0.01" min="0" required />
                    </div>
                    <div style="width:120px">
                        <label for="p-stock">Stock</label>
                        <input id="p-stock" name="stock" type="number" min="0" value="1" />
                    </div>
                    <div style="width:160px">
                        <label for="p-estado">Estado</label>
                        <select id="p-estado" name="estado">
                            <option value="disponible">Disponible</option>
                            <option value="sin stock">Sin stock</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <label for="p-categoria">Categoría</label>
                    <select id="p-categoria" name="categoria">
                        <option value="">(Seleccionar)</option>
                    </select>
                    <div id="new-category-row" style="display:none;margin-top:8px">
                        <input id="p-categoria-new" type="text" placeholder="Nombre nueva categoría" style="margin-right:8px" />
                        <button type="button" id="p-categoria-create" class="btn">Crear categoría</button>
                    </div>
                </div>
                <div class="form-row">
                    <label for="p-imagen">Imagen (jpg, jpeg, png)</label>
                    <input id="p-imagen" name="imagen" type="file" accept="image/jpeg,image/jpg,image/png" />
                    <small class="muted">Si se sube imagen, se codificará en base64 y se enviará junto a los
                        datos.</small>
                </div>
                <div class="form-row">
                    <label for="p-descuento">Descuento (%)</label>
                    <input id="p-descuento" name="porcentaje_descuento" type="number" step="0.01" min="0" max="100" value="0" />
                </div>
                <input type="hidden" id="p-id" name="id" value="" />
                <div id="add-product-error" style="color:#c00;margin-top:6px;display:none"></div>
                <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
                    <button type="button" id="cancel-add" class="btn">Cancelar</button>
                    <button type="submit" id="submit-add" class="btn primary">Crear producto</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../js/include.js"></script>
    <script src="../../js/navbar.js"></script>
    <script src="../../js/sidebar.js"></script>
    <script>
        async function loadInventory() {
            const tbody = document.querySelector('#inventory-table tbody');
            const empty = document.getElementById('inventory-empty');
            const caption = document.querySelector('#inventory-table caption');
            caption.textContent = 'Actualizando...';
            try {
                const res = await fetch('../../php/api/products.php');
                if (!res.ok) throw new Error('Error fetching products: ' + res.status);
                const data = await res.json();
                // Support API returning either an array or { success, productos }
                let list = [];
                if (data && data.success && Array.isArray(data.productos)) list = data.productos;
                else if (Array.isArray(data)) list = data;

                // Expecting array of products
                if (!Array.isArray(list) || list.length === 0) {
                    document.querySelector('#inventory-table thead').style.display = 'table-header-group';
                    tbody.innerHTML = '';
                    caption.textContent = '';
                    empty.style.display = 'block';
                    return;
                }
                empty.style.display = 'none';
                tbody.innerHTML = '';
                caption.textContent = `Mostrando ${list.length} producto(s)`;
                list.forEach(p => {
                    const tr = document.createElement('tr');
                    const idTd = document.createElement('td');
                    idTd.textContent = p.id_producto ?? p.id ?? '';
                    tr.appendChild(idTd);

                    const nameTd = document.createElement('td');
                    nameTd.textContent = p.nombre ?? p.name ?? '';
                    tr.appendChild(nameTd);

                    const priceTd = document.createElement('td');
                    // Ensure decimal separator handled and always show two decimals
                    let priceStr = '';
                    const rawPrice = (p.precio !== undefined && p.precio !== null) ? String(p.precio).trim() : '';
                    if (rawPrice !== '') {
                        // accept comma as decimal separator
                        const normalized = rawPrice.replace(',', '.');
                        const num = Number(normalized);
                        if (!Number.isNaN(num)) {
                            // use Intl formatter when available
                            const fmt = window.formatPrice || function (v) {
                                try { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 2 }).format(Number(v) || 0); }
                                catch (e) { return '$ ' + (Number(v) || 0).toFixed(2); }
                            };
                            priceStr = fmt(num);
                        }
                    }
                    priceTd.textContent = priceStr;
                    tr.appendChild(priceTd);

                    const stockTd = document.createElement('td');
                    const stockVal = (p.stock !== undefined && p.stock !== null) ? Number(p.stock) : null;
                    if (stockVal === null) {
                        stockTd.textContent = '—';
                    } else if (stockVal <= 0) {
                        stockTd.textContent = 'Sin existencia';
                        stockTd.style.color = '#c00';
                    } else {
                        stockTd.textContent = String(stockVal);
                    }
                    tr.appendChild(stockTd);

                    // Actions column: Edit button
                    const actionsTd = document.createElement('td');
                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.className = 'btn';
                    editBtn.textContent = 'Editar';
                    editBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        // populate modal with product data for editing
                        const id = p.id_producto ?? p.id ?? null;
                        document.getElementById('p-id').value = id ?? '';
                        document.getElementById('p-nombre').value = p.nombre ?? p.title ?? '';
                        document.getElementById('p-descripcion').value = p.descripcion ?? p.description ?? '';
                        document.getElementById('p-precio').value = (p.precio ?? p.price ?? '') ;
                        document.getElementById('p-stock').value = (p.stock ?? p.cantidad ?? '') ;
                        const estadoEl = document.getElementById('p-estado');
                        if (estadoEl && (p.estado ?? null) !== null) estadoEl.value = p.estado;
                        const catEl = document.getElementById('p-categoria');
                        if (catEl) {
                            // prefer selecting by id if available
                            const catId = p.id_categoria ?? p.idCategoria ?? null;
                            const catName = p.categoria ?? p.category ?? null;
                            if (catId !== null && catId !== undefined) {
                                let opt = Array.from(catEl.options).find(o => o.value === String(catId));
                                if (!opt) {
                                    opt = document.createElement('option'); opt.value = String(catId); opt.textContent = catName || String(catId); catEl.appendChild(opt);
                                }
                                catEl.value = String(catId);
                            } else if (catName) {
                                // fallback to name-based option if id not present
                                let opt = Array.from(catEl.options).find(o => o.value === catName);
                                if (!opt) {
                                    opt = document.createElement('option'); opt.value = catName; opt.textContent = catName; catEl.appendChild(opt);
                                }
                                catEl.value = catName;
                            }
                        }
                        // porcentaje_descuento (may be present as porcentaje_descuento or porcentaje_descuento in raw)
                        const descEl = document.getElementById('p-descuento');
                        if (descEl) descEl.value = (p.porcentaje_descuento ?? p.porcentaje ?? p.descuento ?? 0);
                        // update button text and show modal (manual open because showModal is inside another scope)
                        const submitBtn = document.getElementById('submit-add');
                        if (submitBtn) submitBtn.textContent = 'Actualizar producto';
                        const modalEl = document.getElementById('add-product-modal');
                        if (modalEl) {
                            modalEl.style.display = 'block';
                            modalEl.setAttribute('aria-hidden', 'false');
                            document.body.style.overflow = 'hidden';
                        }
                    });
                    actionsTd.appendChild(editBtn);
                    tr.appendChild(actionsTd);

                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
                caption.textContent = '';
                empty.style.display = 'block';
                empty.textContent = 'Error cargando productos — abre la consola para más detalles.';
            }
        }

        // load on page ready
        async function loadCategories() {
            try {
                const res = await fetch('../../php/api/categories.php');
                if (!res.ok) throw new Error('Error fetching categories: ' + res.status);
                const data = await res.json();
                let list = [];
                if (data && data.success && Array.isArray(data.categorias)) list = data.categorias;
                else if (Array.isArray(data)) list = data;
                const sel = document.getElementById('p-categoria');
                if (!sel) return;
                // clear existing (keep first placeholder)
                sel.innerHTML = '<option value="">(Seleccionar)</option>';
                list.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = (c.id_categoria ?? c.id ?? '');
                    opt.textContent = c.nombre ?? c.name ?? '';
                    sel.appendChild(opt);
                });
                // add option to create a new category inline
                const optNew = document.createElement('option');
                optNew.value = '_new';
                optNew.textContent = 'Crear nueva categoría...';
                sel.appendChild(optNew);
            } catch (err) {
                console.error('Could not load categories', err);
            }
        }

        document.addEventListener('DOMContentLoaded', () => { loadInventory(); loadCategories(); });
            // handle create-new-category inline UI
            const catSelect = document.getElementById('p-categoria');
            const newRow = document.getElementById('new-category-row');
            const newInput = document.getElementById('p-categoria-new');
            const createBtn = document.getElementById('p-categoria-create');

            if (catSelect) {
                catSelect.addEventListener('change', () => {
                    if (catSelect.value === '_new') {
                        if (newRow) newRow.style.display = 'block';
                        if (newInput) newInput.focus();
                    } else {
                        if (newRow) newRow.style.display = 'none';
                    }
                });
            }

            if (createBtn) {
                createBtn.addEventListener('click', async () => {
                    if (!newInput) return;
                    const name = newInput.value.trim();
                    if (!name) {
                        const errorBoxLocal = document.getElementById('add-product-error');
                        if (errorBoxLocal) {
                            errorBoxLocal.textContent = 'Introduce un nombre de categoría';
                            errorBoxLocal.style.display = 'block';
                        }
                        return;
                    }
                    createBtn.disabled = true;
                    try {
                        const res = await fetch('/php/api/create_category.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ nombre: name, descripcion: '' })
                        });
                        const data = await res.json();
                        if (!res.ok || !data || !data.ok) {
                            throw new Error(data && data.error ? data.error : 'Error creando categoría');
                        }
                        // append new option and select it (use returned id when available)
                        const opt = document.createElement('option');
                        const newId = data.id_categoria ?? (data.categoria && (data.categoria.id_categoria ?? null));
                        const catName = (data.categoria && (data.categoria.nombre ?? data.categoria)) || name;
                        opt.value = newId !== null && newId !== undefined ? String(newId) : catName;
                        opt.textContent = catName;
                        opt.selected = true;
                        if (catSelect) catSelect.appendChild(opt);
                        if (newRow) newRow.style.display = 'none';
                        newInput.value = '';
                    } catch (err) {
                        console.error(err);
                        const errorBoxLocal = document.getElementById('add-product-error');
                        if (errorBoxLocal) {
                            errorBoxLocal.textContent = err.message || 'Error creando categoría';
                            errorBoxLocal.style.display = 'block';
                        }
                    } finally {
                        createBtn.disabled = false;
                    }
                });
            }
    </script>
    <script>
        // Modal and add-product form logic
        (function () {
            const openBtn = document.getElementById('open-add-product');
            const modal = document.getElementById('add-product-modal');
            const closeBtn = document.getElementById('close-add-product');
            const cancelBtn = document.getElementById('cancel-add');
            const form = document.getElementById('add-product-form');
            const errorBox = document.getElementById('add-product-error');
            const submitBtn = document.getElementById('submit-add');

            function showModal() {
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
            }
            function hideModal() {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = '';
                errorBox.style.display = 'none';
                form.reset();
                const submitBtn = document.getElementById('submit-add');
                if (submitBtn) submitBtn.textContent = 'Crear producto';
                const idEl = document.getElementById('p-id');
                if (idEl) idEl.value = '';
                const descEl = document.getElementById('p-descuento');
                if (descEl) descEl.value = 0;
            }

            openBtn && openBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showModal();
            });
            closeBtn && closeBtn.addEventListener('click', hideModal);
            cancelBtn && cancelBtn.addEventListener('click', hideModal);

            // validate image type
            function validateImageFile(file) {
                if (!file) return true; // optional
                const allowed = ['image/jpeg', 'image/jpg', 'image/png'];
                return allowed.includes(file.type);
            }

            async function readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const fr = new FileReader();
                    fr.onload = () => resolve(fr.result);
                    fr.onerror = () => reject(new Error('Error leyendo la imagen'));
                    fr.readAsDataURL(file);
                });
            }

            form && form.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                errorBox.style.display = 'none';
                submitBtn.disabled = true;

                const nombre = document.getElementById('p-nombre').value.trim();
                const descripcion = document.getElementById('p-descripcion').value.trim();
                const precio = document.getElementById('p-precio').value;
                const stock = document.getElementById('p-stock').value;
                const categoriaRaw = document.getElementById('p-categoria').value;
                const categoria = categoriaRaw ? categoriaRaw.trim() : '';
                const estado = document.getElementById('p-estado').value;
                const fileInput = document.getElementById('p-imagen');
                const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

                if (!nombre || !descripcion || precio === '') {
                    errorBox.textContent = 'Rellena nombre, descripción y precio.';
                    errorBox.style.display = 'block';
                    submitBtn.disabled = false;
                    return;
                }

                if (file && !validateImageFile(file)) {
                    errorBox.textContent = 'Formato de imagen no permitido. Usa jpg, jpeg o png.';
                    errorBox.style.display = 'block';
                    submitBtn.disabled = false;
                    return;
                }

                try {
                    let imagen_base64 = null;
                    let imagen_nombre = null;
                    if (file) {
                        const dataUrl = await readFileAsDataURL(file);
                        // dataUrl = data:<mime>;base64,BBBB
                        imagen_base64 = dataUrl.split(',')[1];
                        imagen_nombre = file.name;
                    }

                        const descuentoVal = document.getElementById('p-descuento') ? (document.getElementById('p-descuento').value) : 0;
                        const payload = {
                            nombre,
                            descripcion,
                            precio,
                            stock: stock ? Number(stock) : 1,
                            estado: estado || 'disponible',
                            porcentaje_descuento: descuentoVal !== '' ? Number(descuentoVal) : 0,
                        };
                        // prefer sending id_categoria when an ID value is selected
                        if (categoria && categoria !== '_new' && /^\d+$/.test(categoria)) {
                            payload.id_categoria = Number(categoria);
                        } else {
                            payload.categoria = categoria || null;
                        }
                    if (imagen_base64) {
                        payload.imagen_base64 = imagen_base64;
                        payload.imagen_nombre = imagen_nombre;
                    }

                    // if p-id present, update existing product
                    const existingId = document.getElementById('p-id') ? document.getElementById('p-id').value : '';
                    let res;
                    if (existingId) {
                        payload.id = Number(existingId);
                        res = await fetch('/php/api/update_product.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });
                    } else {
                        res = await fetch('/php/api/create_product.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });
                    }
                    const data = await res.json();
                    if (!res.ok || !data || !data.ok) {
                        throw new Error((data && data.error) ? data.error : ('Error server: ' + res.status));
                    }

                    // success: close modal and reload inventory
                    hideModal();
                    // small delay to allow DB commit on slower servers
                    setTimeout(() => loadInventory(), 300);
                } catch (err) {
                    console.error(err);
                    errorBox.textContent = err.message || 'Error creando producto';
                    errorBox.style.display = 'block';
                } finally {
                    submitBtn.disabled = false;
                }
            });
        })();
    </script>
</body>

</html>